version: '3.8'

services:
  # Config sync service - pulls latest config from GitHub before other services start
  config-sync:
    image: alpine:latest
    container_name: kometa-config-sync
    volumes:
      - ./:/git
    command: >
      sh -c "
        apk add --no-cache git &&
        cd /git &&
        git config --global --add safe.directory /git &&
        git pull origin main || echo 'Git pull failed or no changes'
      "
    restart: "no"


  # Kometa for kempfnas2
  kometa-kempfnas2:
    image: kometateam/kometa:latest
    container_name: kometa-kempfnas2
    depends_on:
      config-sync:
        condition: service_completed_successfully
    restart: unless-stopped
    network_mode: host
    environment:
      # Server-specific Plex URL (only thing that differs per server)
      - KOMETA_PLEXURL=http://10.100.103.17:32400

      # All other secrets are shared (from .env file)
      - KOMETA_PLEXTOKEN=${PLEX_TOKEN}
      - KOMETA_TMDBKEY=${TMDB_KEY}
      - KOMETA_OMDBKEY=${OMDB_KEY}
      - KOMETA_RADARRTOKEN=${RADARR_TOKEN}
      - KOMETA_SONARRTOKEN=${SONARR_TOKEN}
    volumes:
      # Shared config (read-only)
      - ./config.yml:/config/config.yml:ro

      # Server-specific writable directories
      - kempfnas2-logs:/config/logs
      - kempfnas2-cache:/config/cache
    command: --run --read-only-config

  # Kometa for kempfplex1
  kometa-kempfplex1:
    image: kometateam/kometa:latest
    container_name: kometa-kempfplex1
    depends_on:
      config-sync:
        condition: service_completed_successfully
    restart: unless-stopped
    dns:
      - 10.100.103.1
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      # Server-specific Plex URL (only thing that differs per server)
      - KOMETA_PLEXURL=http://192.168.101.61:32400

      # All other secrets are shared (from .env file)
      - KOMETA_PLEXTOKEN=${PLEX_TOKEN}
      - KOMETA_TMDBKEY=${TMDB_KEY}
      - KOMETA_OMDBKEY=${OMDB_KEY}
      - KOMETA_RADARRTOKEN=${RADARR_TOKEN}
      - KOMETA_SONARRTOKEN=${SONARR_TOKEN}
    volumes:
      # Shared config (read-only)
      - ./config.yml:/config/config.yml:ro

      # Server-specific writable directories
      - kempfplex1-logs:/config/logs
      - kempfplex1-cache:/config/cache
    command: --run --read-only-config

  # Kometa for DEMARIA-DT
  kometa-demaria-dt:
    image: kometateam/kometa:latest
    container_name: kometa-demaria-dt
    depends_on:
      config-sync:
        condition: service_completed_successfully
    restart: unless-stopped
    dns:
      - 10.100.103.1
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      # Server-specific Plex URL (only thing that differs per server)
      - KOMETA_PLEXURL=http://10.200.201.99:32400

      # All other secrets are shared (from .env file)
      - KOMETA_PLEXTOKEN=${PLEX_TOKEN}
      - KOMETA_TMDBKEY=${TMDB_KEY}
      - KOMETA_OMDBKEY=${OMDB_KEY}
      - KOMETA_RADARRTOKEN=${RADARR_TOKEN}
      - KOMETA_SONARRTOKEN=${SONARR_TOKEN}
    volumes:
      # Shared config (read-only)
      - ./config.yml:/config/config.yml:ro

      # Server-specific writable directories
      - demaria-dt-logs:/config/logs
      - demaria-dt-cache:/config/cache
    command: --run --read-only-config

# Named volumes for logs and cache (persists between container restarts)
volumes:
  kempfnas2-logs:
  kempfnas2-cache:
  kempfplex1-logs:
  kempfplex1-cache:
  demaria-dt-logs:
  demaria-dt-cache:
